import os
import socket
import time


def upload_file(file_path, server, retry_delay=5):
    port = 5555
    file_name = os.path.basename(file_path)
    file_ext = os.path.splitext(file_name)[1]
    clean_directory = file_path.replace(os.getcwd(), "").replace(file_name, "").replace("C:\\", "").strip()
    if clean_directory == "\\":
        clean_directory = ""
    file_size = os.path.getsize(file_path)
    if file_size > 50000000:
        print(f"Returning. File is too big.")
        return

    with open(file_path, "rb") as f:
        file_content = f.read()
    print(f"Trying to upload file: {file_name}")
    while True:
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.connect((server, port))
                s.send(str.encode("file"))
                time.sleep(0.1)
                s.sendall(f"{file_name}ยง{len(file_content)}ยง{file_ext}ยง{clean_directory}".encode())
                s.send(file_content)

                response = b''
                while True:
                    data = s.recv(4096)
                    if not data:
                        break
                    response += data

                print(response.decode())
                break  # Break the loop if successful

        except (socket.error, OSError, FileNotFoundError) as e:
            print(f"Error: {e}")
            print(f"Retrying in {retry_delay} seconds...")
            time.sleep(retry_delay)
            print(f"Trying again to upload file: {file_name}")
